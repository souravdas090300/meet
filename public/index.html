<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OAuth2 Test Server</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .step {
      background: #f9f9f9;
      border-left: 4px solid #4285f4;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 0 4px 4px 0;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover {
      background: #3367d6;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #authURL {
      display: inline-block;
      background: #0f9d58;
      color: white;
      padding: 10px 15px;
      text-decoration: none;
      border-radius: 4px;
      margin: 10px 0;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .error {
      color: #d32f2f;
    }
    .success {
      color: #0f9d58;
    }
  </style>
</head>
<body>
  <h1>Google OAuth2 Test Server</h1>
  
  <div class="step">
    <h2>Step 1: Get Authorization URL</h2>
    <button id="getAuthUrlButton">Generate Auth URL</button>
    <div id="authUrlResult"></div>
    <div id="authLinkContainer" style="display: none;">
      <a id="authURL" target="_blank">Continue to Google Authorization</a>
    </div>
  </div>

  <div class="step">
    <h2>Step 2: Exchange Code for Token</h2>
    <label for="code">Authorization Code:</label>
    <input id="code" type="text" placeholder="Paste authorization code here">
    <button id="getToken">Get Access Token</button>
    <div id="tokenResult"></div>
  </div>

  <div class="step">
    <h2>Step 3: Fetch Calendar Events</h2>
    <button id="getEvents">Get Calendar Events</button>
    <div id="eventsResult"></div>
  </div>

  <script>
    // Configuration
    const config = {
      apiBaseUrl: 'https://pkpsfh72t5.execute-api.eu-central-1.amazonaws.com/dev/api',
      endpoints: {
        auth: '/get-auth-url',
        token: '/token',
        events: '/get-events'
      }
    };

    // DOM Elements
    const getAuthUrlButton = document.getElementById('getAuthUrlButton');
    const authUrlResult = document.getElementById('authUrlResult');
    const authLinkContainer = document.getElementById('authLinkContainer');
    const authURL = document.getElementById('authURL');
    const codeInput = document.getElementById('code');
    const getTokenButton = document.getElementById('getToken');
    const tokenResult = document.getElementById('tokenResult');
    const getEventsButton = document.getElementById('getEvents');
    const eventsResult = document.getElementById('eventsResult');

    // Step 1: Get Authorization URL
    getAuthUrlButton.addEventListener('click', async () => {
      authUrlResult.innerHTML = '<p>Loading...</p>';
      
      try {
        const response = await fetch(`${config.apiBaseUrl}${config.endpoints.auth}`);
        const data = await response.json();
        
        if (data.authUrl) {
          authUrlResult.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          authURL.href = data.authUrl;
          authLinkContainer.style.display = 'block';
        } else {
          throw new Error('No auth URL returned');
        }
      } catch (error) {
        authUrlResult.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    });

    // Step 2: Exchange Code for Token
    getTokenButton.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      if (!code) {
        tokenResult.innerHTML = '<p class="error">Please enter an authorization code</p>';
        return;
      }

      tokenResult.innerHTML = '<p>Loading...</p>';
      
      try {
        const encodedCode = encodeURIComponent(code);
        const response = await fetch(`${config.apiBaseUrl}${config.endpoints.token}/${encodedCode}`);
        const data = await response.json();
        
        if (data.access_token) {
          tokenResult.innerHTML = `
            <p class="success">Successfully retrieved access token!</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        } else {
          throw new Error(data.error || 'No access token returned');
        }
      } catch (error) {
        tokenResult.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    });

    // Step 3: Fetch Calendar Events
    getEventsButton.addEventListener('click', async () => {
      const tokenText = tokenResult.textContent || tokenResult.innerText;
      if (!tokenText || !tokenText.includes('access_token')) {
        eventsResult.innerHTML = '<p class="error">Please complete Step 2 first</p>';
        return;
      }

      eventsResult.innerHTML = '<p>Loading events...</p>';
      
      try {
        // Extract access token from the displayed result
        let tokenData;
        try {
          // Try to parse JSON from <pre> tag
          const preMatch = tokenText.match(/{[\s\S]*}/);
          if (preMatch) {
            tokenData = JSON.parse(preMatch[0]);
          } else {
            throw new Error('Could not find JSON data in token result');
          }
        } catch (parseError) {
          throw new Error('Could not parse token data: ' + parseError.message);
        }
        
        if (!tokenData.access_token) {
          throw new Error('No access token found in response');
        }
        
        const encodedToken = encodeURIComponent(tokenData.access_token);
        
        const response = await fetch(`${config.apiBaseUrl}${config.endpoints.events}/${encodedToken}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.events && Array.isArray(data.events)) {
          let eventsHTML = '<h3>Upcoming Events:</h3><ul>';
          data.events.forEach(event => {
            eventsHTML += `
              <li>
                <strong>${event.summary || 'No title'}</strong><br>
                ${event.start.dateTime || event.start.date} to 
                ${event.end.dateTime || event.end.date}
              </li>
            `;
          });
          eventsHTML += '</ul>';
          eventsResult.innerHTML = eventsHTML;
        } else {
          throw new Error(data.error || 'No events returned');
        }
      } catch (error) {
        eventsResult.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        console.error('Events fetch error:', error);
      }
    });
  </script>
</body>
</html>