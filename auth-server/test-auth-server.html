<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="utf-8" />
   <meta http-equiv="x-ua-compatible" content="ie=edge" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="manifest" href="../public/manifest.json" />
   <link rel="icon" href="../public/vite.svg" type="image/svg+xml" />

   <title>Test Auth Server</title>
 </head>


 <body>
   <style>
     #container {
       max-width: 800px;
       margin: 0 auto;
       padding: 20px;
       font-family: Arial, sans-serif;
     }
     h4 {
       margin-top: 25px;
       color: #333;
     }
     button {
       background-color: #4CAF50;
       color: white;
       padding: 10px 20px;
       border: none;
       border-radius: 4px;
       cursor: pointer;
       margin: 10px 0;
     }
     button:hover {
       background-color: #45a049;
     }
     input[type="text"] {
       width: 300px;
       padding: 8px;
       margin: 5px 0;
       border: 1px solid #ddd;
       border-radius: 4px;
     }
     #result, #accessToken, #events {
       background-color: #f9f9f9;
       border: 1px solid #ddd;
       padding: 10px;
       margin: 10px 0;
       border-radius: 4px;
       white-space: pre-wrap;
       word-wrap: break-word;
       max-height: 300px;
       overflow-y: auto;
     }
     .step {
       border: 1px solid #e0e0e0;
       padding: 15px;
       margin: 10px 0;
       border-radius: 8px;
       background-color: #fafafa;
     }
     .warning {
       color: #ff6b6b;
       font-weight: bold;
     }
     #authURL {
       display: none; /* Initially hidden */
       background-color: #2196F3;
       color: white;
       padding: 10px 15px;
       text-decoration: none;
       border-radius: 4px;
       margin: 10px 0;
       transition: background-color 0.3s;
     }
     #authURL:hover {
       background-color: #1976D2;
     }
     #authURL:visited {
       color: white;
     }
     .link-container {
       margin: 15px 0;
       padding: 10px;
       background-color: #f0f8ff;
       border: 1px solid #b3d9ff;
       border-radius: 6px;
       display: none; /* Initially hidden */
     }
     .link-container.show {
       display: block;
     }
   </style>


   <main id="container">
     <h1>OAuth2 Test for Meet App</h1>
     <p>This page tests all three serverless functions: getAuthURL, getAccessToken, and getCalendarEvents</p>
     
     <div class="step">
       <h4><b>Step 1:</b> Get the OAuth URL</h4>
       <p>Click the button below to get your OAuth URL.</p>
       <button id="getAuthUrlButton">Get OAuth URL</button>
       <div id="result"></div>
       <div class="link-container">
         <a id="authURL" href="" target="_blank">ðŸ”— Click to authorize</a>
       </div>
     </div>
     
     <!-- STEP 2 -- MAKE SURE STEP 1 WORKS BEFORE MOVING ON-->
     <div class="step">
       <h4>Step 2: Get your code and exchange for an access token</h4>
       <p>
         After you're redirected back to your Meet app on GitHub, copy the code
         from the URI.
       </p>
       <br />
       <label
         >Code input
         <input id="code" type="text" value="" placeholder="Paste your authorization code here" />
       </label>
       <button id="getToken">Get Token</button>
       <p id="accessToken"></p>
     </div>

     <!-- STEP 3 -- MAKE SURE STEP 2 WORKS BEFORE MOVING ON-->
     <div class="step">
       <h4>Step 3: Get the calendar events using your access token</h4>
       <p class="warning">Note: Make sure you completed Steps 1 and 2 successfully before proceeding.</p>
       <button id="getEvents">Get Events</button>
       <p id="events"></p>
     </div>
   </main>
   <script type="text/javascript">
     // --------------------- STEP 1
     const getAuthUrlButton = document.getElementById("getAuthUrlButton");
     const resultElement = document.getElementById("result");
     const resultLink = document.getElementById("authURL");
     const linkContainer = document.querySelector(".link-container");
     // Replace this with your own endpoint
     const getAuthURL =
       "https://ym392rf9u2.execute-api.eu-central-1.amazonaws.com/api/get-auth-url";


     getAuthUrlButton.onclick = function () {
       resultElement.innerText = "Loading...";
       linkContainer.classList.remove("show"); // Hide link container while loading
       fetch(getAuthURL)
         .then(function (response) {
           return response.json();
         })
         .then(function (json) {
           const result = JSON.stringify(json, null, 2); // Pretty print JSON
           // we get the value of authUrl
           const { authUrl } = JSON.parse(JSON.stringify(json));
           // then add it to the html
           resultElement.innerText = result;
           if (authUrl) {
             resultLink.href = authUrl;
             resultLink.style.display = "inline-block"; // Show link when URL is available
             linkContainer.classList.add("show"); // Show link container
           }
         })
         .catch(function (error) {
           resultElement.innerText = "Error: " + error.message;
           linkContainer.classList.remove("show"); // Hide link container on error
           console.error("Error fetching auth URL:", error);
         });
     };
     // --------------------- END OF STEP 1


     // --------------------- STEP 2
     const codeValue = document.getElementById("code");
     const getAccessToken = document.getElementById("getToken");
     const accessTokenElement = document.getElementById("accessToken");
     const getToken =
       "https://ym392rf9u2.execute-api.eu-central-1.amazonaws.com/api/token";


     getAccessToken.onclick = function () {
       let code = codeValue.value;

       if (!code.trim()) {
         accessTokenElement.innerText = "Error: Please enter the authorization code first.";
         return;
       }

       accessTokenElement.innerText = "Loading...";

       // if the authorization code is not URL-encoded, then URL-encode it.
       if (decodeURIComponent(code) === code) {
         code = encodeURIComponent(codeValue.value);
       }
       const getTokenRequest = getToken +  "/" + code;
       fetch(getTokenRequest)
         .then(function (response) {
           return response.json();
         })
         .then(function (json) {
           accessTokenElement.innerText = JSON.stringify(json);
         })
         .catch(function (error) {
           accessTokenElement.innerText = "Error: " + error.message;
           console.error("Error fetching access token:", error);
         });
     };
     // --------------------- END OF STEP 2

     // --------------------- STEP 3
     const getEvents = document.getElementById("getEvents");
     const events = document.getElementById("events");
     const getCalendarEvents = "https://ym392rf9u2.execute-api.eu-central-1.amazonaws.com/api/get-events";

     getEvents.onclick = function () {
       // Check if access token is available
       if (!accessTokenElement.innerText) {
         events.innerText = "Error: Please get access token first (Step 2)";
         return;
       }

       try {
         const { access_token } = JSON.parse(accessTokenElement.innerText);
         
         if (!access_token) {
           events.innerText = "Error: No access token found. Please complete Step 2 first.";
           return;
         }

         events.innerText = "Loading events...";
         
         const eventRequest = getCalendarEvents + "/" + access_token;
         fetch(eventRequest)
           .then(function (response) {
             return response.json();
           })
           .then(function (json) {
             // Format the events nicely
             if (json.events && json.events.length > 0) {
               let formattedEvents = "Calendar Events:\n\n";
               json.events.forEach((event, index) => {
                 formattedEvents += `${index + 1}. ${event.summary || 'No title'}\n`;
                 formattedEvents += `   Start: ${event.start?.dateTime || event.start?.date || 'No start time'}\n`;
                 formattedEvents += `   End: ${event.end?.dateTime || event.end?.date || 'No end time'}\n`;
                 if (event.description) {
                   formattedEvents += `   Description: ${event.description}\n`;
                 }
                 formattedEvents += `\n`;
               });
               events.innerText = formattedEvents;
             } else {
               events.innerText = "No events found in your calendar.";
             }
           })
           .catch(function (error) {
             events.innerText = "Error fetching events: " + error.message;
             console.error("Error:", error);
           });
       } catch (error) {
         events.innerText = "Error: Invalid access token format. Please complete Step 2 again.";
         console.error("Parse error:", error);
       }
     };


   </script>
 </body>
</html>